---
title: "Coding Assignment 3"
author: "Team 4"
date: "Due: 2021-12-09 23:59"
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
#Put any packages you need here

library(plotly)
library(readxl)
library(corrplot)
library(car)


knitr::opts_chunk$set(echo = TRUE, warning=FALSE)
```

A Florida health insurance company wants to predict annual claims for individual clients. The company pulls a random sample of 50 customers. The owner wishes to charge an actuarially fair premium to ensure a normal rate of return. The owner collects all of their current customer’s health care expenses from the last year and compares them with what is known about each customer’s plan. 

The data on the 50 customers in the sample is as follows:

-	Charges: Total medical expenses for a particular insurance plan (in dollars)
-	Age: Age of the primary beneficiary
-	BMI: Primary beneficiary’s body mass index (kg/m2)
-	Female: Primary beneficiary’s birth sex (0 = Male, 1 = Female)
-	Children: Number of children covered by health insurance plan (includes other dependents as well)
-	Smoker: Indicator if primary beneficiary is a smoker (0 = non-smoker, 1 = smoker)
-	Cities: Dummy variables for each city with the default being Sanford

Answer the following questions using complete sentences and attach all output, plots, etc. within this report.


```{r dataset, include=FALSE}
# Bring in the dataset here.

insurance <- read_excel("../Data/insurance_0126_Group4.xlsx")

```



## Question 1

Randomly select three observations from the sample and exclude from all modeling (i.e. n=47). Provide the summary statistics (min, max, std, mean, median) of the quantitative variables for the 47 observations.

```{r q1}

set.seed(123456)
index <- sample(seq_len(nrow(insurance)), size = 3)

#This will be the data set for 47 observations all columns
train <- insurance[-index,]

#This will be the data set for random 3 observations all columns
test <- insurance[index,]

#Below we will provide the summary statistics (min, max, std, mean, median) of the quantitative variables for the 47 observations

summary(train)[,c(1:3,5)]

#Below we will provide the standard deviation of our quantitative variables:
#Charges:
sd(insurance$Charges)
#Age:
sd(insurance$Age)
#BMI:
sd(insurance$BMI)
#Children:
sd(insurance$Children)


```


## Question 2

Provide the correlation between all quantitative variables

```{r}
corrplot(cor(train[,c(1:3,5)]), addCoef.col = "red")


```


## Question 3

Run a regression that includes all independent variables in the data table. Does the model above violate any of the Gauss-Markov assumptions? If so, what are they and what is the solution for correcting?

```{r q3 p1}

model_1 <- lm(Charges ~., data = train )
summary(train)
summary(model_1)

par(mfrow=c(2,2))
plot(model_1)

```
In this example, the first plot titled “Residuals vs. Fitted,” you should not see a true pattern. In this case,
since there is a non-linear relationship, you’ve already violated a classical assumption.
The second plot titled “Normal Q-Q” shows the assumption of a normally distributed dependent variable for
a fixed set of predictors. If this were a 45-degree line upwards, we could verify this. Unfortunately we do not
have it in this case.
The third plot titled “Scale-Location” checks for homoskedasticity. If this assumption were not violated,
you’d see random points around a horizontal line. In this case, it is upwards sloping, so you can see there is a
“fanning out” effect.
The last plot “Residuals vs. Leverage” keeps an eye out for regression outliers, influential observations, and
high leverage points. (Do not worry about this last plot).

```{r q3 p2}

scatterplotMatrix(train[,c(1:3,5)])


```
From here you can see some non-linear relationships and non-normally distributed variables.





## Question 4

Implement the solutions from question 3, such as data transformation, along with any other changes you wish. Use the sample data  run a new regression. How have the fit measures changed? How have the signs and significance of the coefficients changed?

```{r q4 p1}
#The following transformations were applied due to the nature of the independent variables: 

#For Charges, we decided to apply log in order to fix the distribution.
train$lnCharges <- log(train$Charges)


#with only transforming Charges we have
scatterplotMatrix(train[,c(10,2,3,5)])

```

```{r q4 p2}
#For Children, we decided to apply the log in order to see how that would transform the distribution:
train$lnChildren <- log(train$Children)



```

```{r q4 p3}
#For both both Age and BMI we can assume the quadratic nature of the variables:
#As far as AGE, the younger we are the more medical attention we would need, if we are analizing an adult at a mature age they normally would not need much medical attention, and someone who is at an advanced age (elderly) would probably need more medical attention. 


train$AgeSq <- train$Age^2

train$lnAge <- log(train$Age)

```



```{r q4 p4}

#BMI would almost work the same way, the less BMI the average human has the more likely they will need more medical attention (ANOREXIC), if we are observing an average adult at a normal BMI the less medical attention needed, and someone who is at a higher BMI would probably need more medical attention (OBSESITY).


train$BMISq <- train$BMI^2

train$lnBMI <- log(train$BMI)

```

```{r q4 p5}
#APPLYING TRANSFORMATIONS


#with transforming every variable we get:

#lnage
scatterplotMatrix(train[,c(10,13,14,5)])

#sqage
#with transforming every variable we get:
scatterplotMatrix(train[,c(10,12,14,5)])

#lnBMI
scatterplotMatrix(train[,c(10,13,15,5)])

#with only Charges transformation we have these two histograms:

hist(train$Charges)
hist(train$lnCharges)

```

```{r q4 p6.1}
#CREATING MODELS WITH TRANSFORMATIONS

#MODEL 1
#Model of lnCharges, Age, BMI, Children + Dummies
model_lncharges <-lm(lnCharges ~., data = train[,c(10,2:9)])
summary(model_lncharges)
plot(model_lncharges)

```

```{r q4 p6.2}
#MODEL 2
#Model of lnCharges, lnAge, lnBMI, Children + Dummies
model_lnchargesAgeBMI <-lm(lnCharges ~., data = train[,c(10,13,15, 4:9)])
summary(model_lnchargesAgeBMI)
plot(model_lnchargesAgeBMI)
```

```{r q4 p6.3}
#MODEL 3
#Model of lnCharges, lnAge, BMISq, Children + Dummies
model_lnchargesAgeBMISq <-lm(lnCharges ~., data = train[,c(10,13,14, 4:9)])
summary(model_lnchargesAgeBMISq)
plot(model_lnchargesAgeBMISq)


```
## Question 5

Use the 3 withheld observations and calculate the performance measures for your best two models. Which is the better model? (remember that "better" depends on whether your outlook is short or long run)

```{r q5}
test$lncharges <-log(test$Charges)
test$lnAge <- log(test$Age)
test$lnBMI <- log(test$BMI)
test$BMISq <- test$BMI^2



#bad model
test$model_lncharges_pred <-predict(model_lncharges, newdata = test )
#model 1
test$model_lnchargesAgeBMI_pred <- predict(model_lnchargesAgeBMI, newdata = test) %>% exp()
#model 2
test$model_InChargesAgeBMISq_pred <- predict(model_lnchargesAgeBMISq, newdata = test) %>% exp()


#finding the error
test$error_bm <- test$model_lncharges_pred - test$Charges
test$error_1 <-  test$model_lnchargesAgeBMI_pred - test$Charges
test$error_2 <- test$model_InChargesAgeBMISq_pred - test$Charges


#BIAS
mean(test$error_bm)
mean(test$error_1)
mean(test$error_2)

#MAE
mae <- function(error_vector){
error_vector %>%
abs() %>%
mean()
}

mae(test$error_bm)
mae(test$error_1)
mae(test$error_2)

#RMSE

rmse <- function(error_vector){
error_vector^2 %>%
mean() %>%
sqrt()
}

rmse(test$error_bm)
rmse(test$error_1)
rmse(test$error_2)

#MAPE

mape <- function(error_vector, actual_vector){
(error_vector/actual_vector) %>%
abs() %>%
mean()
}


mape(test$error_bm, test$Charges)
mape(test$error_1, test$Charges)
mape(test$error_2, test$Charges)






```

## Question 6

Provide interpretations of the coefficients, do the signs make sense? Perform marginal change analysis (thing 2) on the independent variables.


```{r q6}
summary(model_lncharges)
summary(model_lnchargesAgeBMI)
summary(model_lnchargesAgeBMISq)

```




## Question 7

An eager insurance representative comes back with five potential clients. Using the better of the two models selected above, provide the prediction intervals for the five potential clients using the information provided by the insurance rep.

| Customer | Age | BMI | Female | Children | Smoker | City           |
| -------- | --- | --- | ------ | -------- | ------ | -------------- | 
| 1        | 60  | 22  | 1      | 0        | 0      | Oviedo         |
| 2        | 40  | 30  | 0      | 1        | 0      | Sanford        |
| 3        | 25  | 25  | 0      | 0        | 1      | Winter Park    |
| 4        | 33  | 35  | 1      | 2        | 0      | Winter Springs |
| 5        | 45  | 27  | 1      | 3        | 0      | Oviedo         |

```{r q7}


```

## Question 8

The owner notices that some of the predictions are wider than others, explain why.


```{r q8}

```

## Question 9 

Are there any prediction problems that occur with the five potential clients? If so, explain.
```{r q9}


```
